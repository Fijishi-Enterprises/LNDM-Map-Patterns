---
title: "Differences FRAGSTATS|landscapemetrics"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Differences FRAGSTATS|landscapemetrics}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
```{r load_libraries_hidden, eval=TRUE, echo=FALSE, message=FALSE, results='hide'}
library(landscapemetrics)
library(dplyr)
library(DT)
```

# General differences

There are a few important differences between **FRAGSTATS** and **landscapemetrics** that you should be aware of if you compare results between the two or use both of the tools:

- FRAGSTATS rounds after the 4th decimal place
  - That also affects the resolution, if your raster has a resolution with more than 4 decimal places the results for metrics that rely on that are wrong (e.g. AREA, xxx) 
- Error in FRAGSTATS for every metric summarized with the coefficient of variation (*metric*_CV)     
  - Example based on AREA metric:   
  ```{r}
  # function to calculate coefficient of variation ((standard deviation divided by the mean) * 100)
  cv <- function(x){
    (sd(x, na.rm=TRUE)/ 
    mean(x, na.rm=TRUE))*100
  }
  
  # 'true' results based an patch level results from fragstats
  fragstats_patch_landscape %>% 
    group_by(TYPE) %>% 
    summarise(CV = cv(AREA)) %>% 
    pull(CV) %>% 
    sort()
  
  # actual results from fragstats on class level
  sort(fragstats_class_landscape$AREA_CV)
  
  # results from landscapemetrics
  sort(lsm_c_area_cv(landscape)$value)
  ``` 
- Error in FRAGSTATS for every metric summarized with the standard deviation (*metric*_SD)     
  - Example based on AREA metric:   
  ```{r}
  # 'true' results based an patch level results from fragstats
  fragstats_patch_landscape %>% 
      group_by(TYPE) %>% 
      summarise(CV = sd(AREA)) %>% 
      pull(CV) %>% 
      sort() %>% 
      round(.,4)
  
  # actual results from fragstats on class level
  sort(fragstats_class_landscape$AREA_SD)
  
  # results from landscapemetrics
  round(sort(lsm_c_area_sd(landscape)$value),4)
  ```

# Specific differences

We thoroughly compared each of our implemented landscape metrics against the results from FRAGSTATS and will give you here a list with why we think the differences in the results exist.

**FRAGSTATS** is unfortunately not an open-source project, so we can't definitely say that some of the metrics have bugs.
However, we try to explain our thinking based on several small examples.

Some metrics in FRAGSTATS are interdependent and thus if there is an error starting at the patch level metric it propagates through every depending metric.
We list these metrics that are different from their FRAGSTATS implementation here under the metric where the error propagation starts.

### CIRCLE metric

Patches with 1 cell get a CIRCLE metric of 0, however, the definition of this metric is:
    
> CIRCLE equals 1 minus patch area (m^2^) divided by the area (m^2^) of the smallest circumscribing circle. (...)

The smallest circle around a quadrat should not have the same area as the quadrat, which is the case in FRAGSTATS:

```{r}
sort(lsm_p_area(landscape)$value) # calculate cell size, 0.0001 == 1 cell
sort(fragstats_patch_landscape_circle <- fragstats_patch_landscape$CIRCLE) # fragstats results for the gyrate metric in the landscape raster
```

Further points:

* Sometimes the abbreviation in the FRAGSTATS manual is CIRCLE, sometimes SQUARE.

#### Error propagation (for metrics based on **CORE** metric)

##### Class level

- CIRCLE_CV (`lsm_c_circle_cv`)
- CIRCLE_MN (`lsm_c_circle_mn`)
- CIRCLE_SD (`lsm_c_circle_sd`)

##### Landscape level

- CIRCLE_CV (`lsm_l_circle_cv`)
- CIRCLE_MN (`lsm_l_circle_mn`)
- CIRCLE_SD (`lsm_l_circle_sd`)

##### Landscape level

### CORE metric

The core metric is defined as:

> CORE equals the area (m^2^) within the patch that is further than the specified depth-of-edge distance from the patch perimeter, [...]

This is a visual aid to help understand how we implemented the core metric:

```{r message=FALSE, fig.retina=2}
library(raster)
library(patchwork)

# class 1
class_1 <- cclabel(landscape)[[1]]

# core area of every patch in class 1, 1 = Edge, 0 = Core
core <- boundaries(class_1, directions = 4)

# the left plot is class 1 of our landscape, 
# the right plot show the core area of these patches (blueish color)
landscapetools::util_plot(class_1) + 
landscapetools::util_plot(core)
```

We look at each patch of every class and count the cells that have 4 neighbors with the value of the specific class.
However, while we can prove that our method works as described in the FRAGSTATS manual, the results of the FRAGSTATS software itself cannot be replicated.

#### Error propagation (for metrics based on **CORE** metric)

##### Patch level

- NCORE metric (`lsm_p_ncore`)
- CAI metric (`lsm_p_cai`)

##### Class level

- CAI_CV (`lsm_c_cai_cv`)
- CAI_MN (`lsm_c_cai_mn`)
- CAI_SD (`lsm_c_cai_sd`)
- CORE_CV (`lsm_c_core_cv`)
- CORE_MN (`lsm_c_core_mn`)
- CORE_SD (`lsm_c_core_sd`)
- CPLAND (`lsm_c_cpland`)
- DCAD (`lsm_c_dcad`)
- DCORE_CV (`lsm_c_dcore_cv`)
- DCORE_MN (`lsm_c_dcore_mn`)
- DCORE_SD (`lsm_c_dcore_sd`)
- NDCA (`lsm_c_ndca_sd`)
- TCA (`lsm_c_tca`)

##### Landscape level

- CAI_CV (`lsm_l_cai_cv`)
- CAI_MN (`lsm_l_cai_mn`)
- CAI_SD (`lsm_l_cai_sd`)
- CORE_CV (`lsm_l_core_cv`)
- CORE_MN (`lsm_l_core_mn`)
- CORE_SD (`lsm_l_core_sd`)
- DCAD (`lsm_l_dcad`)
- DCORE_CV (`lsm_l_dcore_cv`)
- DCORE_MN (`lsm_l_dcore_mn`)
- DCORE_SD (`lsm_l_dcore_sd`)
- NDCA (`lsm_l_ndca`)
- TCA (`lsm_l_ndca`)

### GYRATE metric

From the FRAGSTATS (2015) manual:

> GYRATE = 0 when the patch consists of a single cell

... however, FRAGSTATS returns values of 0.5 for patches with a single cell:

```{r}
sort(lsm_p_area(landscape)$value) # calculate cell size, 0.0001 == 1 cell
sort(fragstats_patch_landscape$GYRATE) # fragstats results for the gyrate metric in the landscape raster
```

#### Error propagation (for metrics based on **GYRATE** metric)

##### Class level

- GYRATE_CV (`lsm_c_gyrate_cv`)
- GYRATE_MN (`lsm_c_gyrate_mn`)
- GYRATE_SD (`lsm_c_gyrate_sd`)

##### Landscape level

- GYRATE_CV (`lsm_l_gyrate_cv`)
- GYRATE_MN (`lsm_l_gyrate_mn`)
- GYRATE_SD (`lsm_l_gyrate_sd`)

### PARA metric

There is a mixup between hectare and meter in documentation and code of FRAGSTATS.
The program uses hectare, whereas the documentation uses square meter in the formula.

We implemented it with square meters, but the result is in principale correct:

```{r}
# results from fragstats
fragstats_patch_landscape_para <- fragstats_patch_landscape$PARA

#calculate para metrics
landscapemetrics_patch_landscape_para <- lsm_p_para(landscape)

# compare and multiply by 10000 to get a hectare 
fragstats_patch_landscape_para %in%
                        round((landscapemetrics_patch_landscape_para$value * 10000), 4)
```


#### Error propagation (for metrics based on **PARA** metric)

##### Class level
- PARA_MN (`lsm_c_para_mn`)
- PARA_SD (`lsm_c_para_sd`)
