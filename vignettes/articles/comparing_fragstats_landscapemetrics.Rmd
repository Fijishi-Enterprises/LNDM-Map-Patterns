---
title: "Comparing FRAGSTSTAS and landscapemetrics"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Comparing FRAGSTSTAS and landscapemetrics}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
```{r load_libraries_hidden, eval=TRUE, echo=FALSE, message=FALSE, results='hide'}
library(landscapemetrics)
library(dplyr)
library(DT)
```

# General

There are a few important differences between **FRAGSTATS** and **landscapemetrics** that you should be aware of if you compare results between the two or use both of the tools:

- FRAGSTATS rounds after the 4th decimal place
  - That also affects the resolution, if your raster has a resolution with more than 4 decimal places the results for metrics that rely on that are wrong (e.g. AREA, xxx) 
- Error in FRAGSTATS for every metric summarized with the coefficient of variation (*metric*_CV)     
  - Example based on AREA metric:   
  ```{r}
  # function to calculate coefficient of variation ((standard deviation divided by the mean) * 100)
  cv <- function(x){
    (sd(x, na.rm=TRUE)/ 
    mean(x, na.rm=TRUE))*100
  }
  
  # 'true' results based an patch level results from fragstats
  fragstats_patch_landscape %>% 
    group_by(TYPE) %>% 
    summarise(CV = cv(AREA)) %>% 
    pull(CV) %>% 
    sort()
  
  # actual results from fragstats on class level
  sort(fragstats_class_landscape$AREA_CV)
  
  # results from landscapemetrics
  sort(lsm_c_area_cv(landscape)$value)
  ```

# Specific differences

We thoroughly compared each of our implemented landscape metrics against the results from FRAGSTATS and will give you here a list with why we think the differences in the results exist.

**FRAGSTATS** is unfortunately not an open-source project, so we can't definitely say that some of the metrics have bugs.
However, we try to explain our thinking based on several small examples.

## Differences on the patch level:

### CAI metric

Metric based on [core metric](https://marcosci.github.io/landscapemetrics/articles/articles/comparing_fragstats_landscapemetrics.html#core-metric),
which already shows a malfunction in FRAGSTATS.
<!-- what does it mean? -->
Therefore most likely just an error propagation starting there. 

### CIRCLE metric

Patches with 1 cell get a CIRCLE metric of 0, however, the definition of this metric is:
    
> CIRCLE equals 1 minus patch area (m^2^) divided by the area (m^2^) of the smallest circumscribing circle. (...)

The smallest circle around a quadrat should not have the same area as the quadrat, which is the case in FRAGSTATS:

```{r}
sort(lsm_p_area(landscape)$value) # calculate cell size, 0.0001 == 1 cell
sort(fragstats_patch_landscape_circle <- fragstats_patch_landscape$CIRCLE) # fragstats results for the gyrate metric in the landscape raster
```

Further points:

* Sometimes the abbreviation in the FRAGSTATS manual is CIRCLE, sometimes SQUARE.

### CORE metric

The core metric is defined as:

> CORE equals the area (m^2^) within the patch that is further than the specified depth-of-edge distance from the patch perimeter, [...]

This is a visual aid to help understand how we implemented the core metric:

```{r message=FALSE, fig.retina=2}
library(raster)
library(patchwork)

# class 1
class_1 <- cclabel(landscape)[[1]]

# core area of every patch in class 1, 1 = Edge, 0 = Core
core <- boundaries(class_1, directions = 4)

# the left plot is class 1 of our landscape, 
# the right plot show the core area of these patches (blueish color)
landscapetools::util_plot(class_1) + 
landscapetools::util_plot(core)
```

We look at each patch of every class and count the cells that have 4 neighbors with the value of the specific class.

However, while we can prove that our method works as described in the FRAGSTATS manual, the results of the FRAGSTATS software itself cannot be replicated.

### GYRATE metric

From the FRAGSTATS (2015) manual:

> GYRATE = 0 when the patch consists of a single cell

... however, FRAGSTATS returns values of 0.5 for patches with a single cell:

```{r}
sort(lsm_p_area(landscape)$value) # calculate cell size, 0.0001 == 1 cell
sort(fragstats_patch_landscape$GYRATE) # fragstats results for the gyrate metric in the landscape raster
```

### NCORE metric

Metric based on [core metric](https://marcosci.github.io/landscapemetrics/articles/articles/comparing_fragstats_landscapemetrics.html#core-metric),
which already shows a malfunction in FRAGSTATS. Therefore most likely just
a error propagation starting there. 

### PARA metric

There is a mixup between hectare and meter in documentation and code of FRAGSTATS.
The program uses hectare, whereas the documentation uses square meter in the formula.

We implemented it with square meters, but the result is in principale correct:

```{r}
# results from fragstats
fragstats_patch_landscape_para <- fragstats_patch_landscape$PARA

#calculate para metrics
landscapemetrics_patch_landscape_para <- lsm_p_para(landscape)

# compare and multiply by 10000 to get a hectare 
fragstats_patch_landscape_para %in%
                        round((landscapemetrics_patch_landscape_para$value * 10000), 4)
```

### SHAPE metric

The documentation of FRAGSTATS formulates the SHAPE metric on patch level as:

$$\frac{(0.25 \times PERIM)}{\sqrt{AREA}}$$

... and FRAGSTATS returns the value of 1.200 for a patch with 5 cells and a perimeter of 12.

However, implementing the same formula in R results in:

```{r}
(0.25 * 12) / sqrt(5)
```


<!-- ## Class level -->

<!-- ```{r, echo=FALSE} -->
<!-- fs_class = data.frame( -->
<!--     metric = c( -->
<!--         "total area", -->
<!--         "patch area (mean)", -->
<!--         "patch area (mean)", -->
<!--         "patch area (mean)", -->
<!--         "patch area (cv)", -->
<!--         "patch area (cv)", -->
<!--         "patch area (cv)", -->
<!--         "patch area (sd)", -->
<!--         "patch area (sd)", -->
<!--         "patch area (sd)", -->
<!--         "percentage of landscape", -->
<!--         "percentage of landscape", -->
<!--         "percentage of landscape", -->
<!--         "largest patch index", -->
<!--         "largest patch index", -->
<!--         "largest patch index", -->
<!--         "number of patches", -->
<!--         "number of patches", -->
<!--         "number of patches", -->
<!--         "euclidean nearest neighbor distance distribution (mean)", -->
<!--         "euclidean nearest neighbor distance distribution (mean)", -->
<!--         "euclidean nearest neighbor distance distribution (mean)" -->
<!--     ), -->
<!--     class = c(NA, 1, 3, 2, 1, 3, 2, 1, 3, 2, 1, 3, 2, 1, 3, 2, -->
<!--               1, 3, 2, 1, 3, 2), -->
<!--     value_fs = c( -->
<!--         NA, -->
<!--         0.002, -->
<!--         0.012, -->
<!--         0.0017, -->
<!--         228.5906, -->
<!--         162.6136, -->
<!--         159.0109, -->
<!--         0.0045, -->
<!--         0.0195, -->
<!--         0.0027, -->
<!--         19.8889, -->
<!--         53.2222, -->
<!--         26.8889, -->
<!--         16.4444, -->
<!--         50.7778, -->
<!--         10.8889, -->
<!--         9, -->
<!--         4, -->
<!--         14, -->
<!--         3.6829, -->
<!--         2, -->
<!--         3.1969 -->
<!--     ) -->
<!-- ) -->

<!-- lsm_class = lsm_calculate(landscape, what = "class") -->

<!-- class = left_join(fs_class, lsm_class, by = c("metric", "class")) %>%  -->
<!--     select(starts_with("valu")) %>%  -->
<!--     select(Value_FRAGSTATS = value_fs, Value_landscapemetrics = value) -->

<!-- datatable(class) -->
<!-- ``` -->

<!-- ## Landscape level -->

<!-- ```{r, echo=FALSE} -->
<!-- fs_land = data.frame( -->
<!--     metric = c( -->
<!--         "total area", -->
<!--         "patch area (mean)", -->
<!--         "patch area (cv)", -->
<!--         "patch area (sd)", -->
<!--         "largest patch index", -->
<!--         "total edge", -->
<!--         "number of patches", -->
<!--         "patch richness", -->
<!--         "patch richness density", -->
<!--         "relative patch richness", -->
<!--         "euclidean nearest neighbor distance distribution (mean)", -->
<!--         "Shannon's evenness index", -->
<!--         "Shannon's diversity index" -->
<!--     ), -->
<!--     value_fs = c( -->
<!--         0.09, -->
<!--         0.0033, -->
<!--         268.3046, -->
<!--         0.0089, -->
<!--         50.7778, -->
<!--         364, -->
<!--         27, -->
<!--         3, -->
<!--         3333.3333, -->
<!--         NA, -->
<!--         .1816, -->
<!--         0.9194, -->
<!--         1.0101 -->
<!--     ) -->
<!-- ) -->

<!-- lsm_land = lsm_calculate(landscape, what = "landscape") -->

<!-- land = left_join(fs_land, lsm_land, by = "metric") %>% -->
<!--     select(starts_with("valu")) %>%  -->
<!--     select(Value_FRAGSTATS = value_fs, Value_landscapemetrics = value) -->

<!-- datatable(land) -->
<!-- ``` -->
